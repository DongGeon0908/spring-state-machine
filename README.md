# Spring State Machine 주문 관리 시스템

이 프로젝트는 Spring State Machine을 사용하여 주문 처리 워크플로우를 구현한 예제입니다. 주문의 생성부터 배송 완료까지의 전체 라이프사이클을 상태 머신을 통해 관리합니다.

## 주요 기능

### 1. 기본 상태 관리
- 주문 상태 전이 관리 (CREATED → PAID → SHIPPED → DELIVERED)
- 주문 취소 처리 (CREATED/PAID → CANCELLED)
- 환불 처리 (CANCELLED → REFUNDED)

### 2. 고급 상태 머신 기능

#### 가드(Guard)
가드는 상태 전이가 발생할 수 있는지 여부를 결정하는 조건입니다.

- **결제 가능 여부 확인**: 주문 금액이 유효한지 확인
- **배송 가능 여부 확인**: 배송지 정보가 유효한지 확인
- **취소 가능 여부 확인**: 현재 상태에서 취소가 가능한지 확인
- **결제 방법 선택 가드**: 신용카드/계좌이체 등 결제 방법에 따른 처리
- **배송 방법 선택 가드**: 일반/빠른 배송 등 배송 방법에 따른 처리

#### 액션(Action)
액션은 상태 전이 중에 실행되는 작업입니다.

- **결제 액션**: 결제 처리 및 결제 정보 저장
- **배송 시작 액션**: 배송 처리 및 운송장 번호 생성
- **배송 완료 액션**: 배송 완료 처리 및 리뷰 요청 이메일 발송
- **주문 취소 액션**: 취소 처리 및 환불 처리
- **오류 처리 액션**: 상태 머신 오류 발생 시 로깅 및 복구 시도

#### 선택 상태(Choice State)
런타임에 조건에 따라 다른 상태로 전이하는 결정 지점입니다.

- **결제 방법 선택**: 결제 방법에 따라 다른 처리 경로로 분기

#### 정션 상태(Junction State)
설정 시점에 조건에 따라 다른 상태로 전이하는 분기점입니다.

- **배송 조건 확인**: 배송 조건에 따라 다른 처리 경로로 분기

#### 리스너(Listener)
상태 머신의 이벤트를 모니터링하고 로깅합니다.

- **상태 변경 모니터링**: 상태 변경 시 로그 기록
- **전이 시작/완료 모니터링**: 전이 시작 및 완료 시 로그 기록
- **이벤트 거부 모니터링**: 이벤트가 거부되었을 때 로그 기록
- **오류 모니터링**: 상태 머신 오류 발생 시 로그 기록

### 3. 상태 머신 시각화 및 모니터링

- **상태 머신 다이어그램**: DOT 형식으로 상태 머신 구조 시각화
- **상태 머신 구조 조회**: JSON 형식으로 상태 머신 구조 정보 제공
- **상태 머신 상태 조회**: 특정 주문의 현재 상태 조회

### 4. 상태 머신 영속성

- **Redis를 사용한 상태 저장**: 상태 머신의 상태를 Redis에 저장
- **상태 복원**: Redis에서 상태를 복원하여 상태 머신 재구성
- **오류 처리 및 재시도**: 상태 저장/복원 중 오류 발생 시 재시도 로직

## API 엔드포인트

### 주문 관리 API
- `POST /api/orders`: 새 주문 생성
- `GET /api/orders/{orderNumber}`: 주문 조회
- `GET /api/orders`: 모든 주문 조회
- `GET /api/orders/state/{state}`: 특정 상태의 주문 조회
- `POST /api/orders/{orderNumber}/events`: 주문 상태 변경 이벤트 발생

### 상태 머신 시각화 API
- `GET /api/state-machine/diagram`: 상태 머신 다이어그램 생성
- `GET /api/state-machine/structure`: 상태 머신 구조 조회
- `GET /api/state-machine/{orderNumber}/state`: 특정 주문의 상태 머신 상태 조회

## 기술 스택

- **Spring Boot**: 애플리케이션 프레임워크
- **Spring State Machine**: 상태 머신 구현
- **Spring Data JPA**: 데이터 액세스
- **Spring Data Redis**: 상태 머신 상태 저장
- **MySQL**: 주문 데이터 저장
- **Kotlin**: 프로그래밍 언어

## 실행 방법

1. MySQL 및 Redis 서버 실행
2. 데이터베이스 생성: `CREATE DATABASE state_machine;`
3. 애플리케이션 실행: `./gradlew bootRun`
4. API 테스트: Postman 또는 curl 사용

## 상태 머신 다이어그램 시각화

상태 머신 다이어그램을 시각화하려면:

1. `/api/state-machine/diagram` 엔드포인트에 GET 요청
2. 반환된 DOT 코드를 GraphViz 온라인 도구(예: http://viz-js.com/)에 붙여넣기
3. 상태 머신의 구조가 시각화된 이미지 확인
